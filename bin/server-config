#!/usr/bin/php
<?php

/**
 * Copyright 2015 FranÃ§ois Kooman <fkooman@tuxed.net>.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
require_once dirname(__DIR__).'/vendor/autoload.php';

use fkooman\VPN\Server\Config\ServerConfig;
use fkooman\Config\Reader;
use fkooman\Config\YamlFile;
use GuzzleHttp\Client;
use fkooman\VPN\Server\Config\IP;
use fkooman\VPN\Server\Utils;

try {
    $dhLength = 2048;

    // get common name from first parameter
    if (2 > $argc) {
        $syntaxMessage = [
            sprintf('syntax: %s [cn]', $argv[0]),
        ];

        throw new Exception(implode(PHP_EOL, $syntaxMessage));
    }
    $commonName = $argv[1];

    $mainConfig = new Reader(
        new YamlFile(dirname(__DIR__).'/config/config.yaml')
    );

    $ipConfig = new Reader(
        new YamlFile(dirname(__DIR__).'/config/ip.yaml')
    );

    $client = new Client(
        [
            'defaults' => [
                'headers' => [
                    'Authorization' => sprintf('Bearer %s', $mainConfig->v('remoteApi', 'vpn-ca-api', 'token')),
                ],
            ],
        ]
    );

    $requestUri = $mainConfig->v('remoteApi', 'vpn-ca-api', 'uri');

    $configData = $client->post(
        $requestUri.'/certificate/',
        [
            'headers' => [
                'Accept' => 'application/json',
            ],
            'body' => [
                'common_name' => $commonName,
                'cert_type' => 'server',
            ],
        ]
    )->json();

#    $ip = new IP($ipConfig->v('v4', 'range'));

    $dhFile = tempnam(sys_get_temp_dir(), 'dh_');
    #Utils::exec(sprintf('/usr/bin/openssl dhparam -out %s %d >/dev/null 2>/dev/null', $dhFile, $dhLength));

    if (false === $dhContent = @file_get_contents($dhFile)) {
        throw new Exception('unable to read DH file');
    }

    $dhParam = ['dh' => trim($dhContent)];
    @unlink($dhFile); // we don't care if this fails

    $openVpnConfig = $mainConfig->v('openVpn');

    // we assume most users will be in the 'default' group so we split the 
    // IP space of default in n(=number of OpenVPN instances on the current 
    // machine) and assign that to each of the instances, that way we do not
    // need to fiddle with the routing table for the default group users in
    // client-connect
    $ipDefaultRange = new IP($ipConfig->v('v4', 'pools', 'default', 'range'));
    $defaultRanges = $ipDefaultRange->splitRange(count($openVpnConfig));

    $serverConfig = new ServerConfig();

    for ($i = 0; $i < count($openVpnConfig); ++$i) {
        $k = array_keys($openVpnConfig)[$i];
        $v = $openVpnConfig[$k];

        $instanceConfig = [];
        $instanceConfig['dev'] = sprintf('tun-%s', $k);
        if ('udp' === $v['proto']) {
            $instanceConfig['proto'] = 'udp6';
        } else {
            $instanceConfig['proto'] = 'tcp-server';
        }
        $instanceConfig['port'] = $v['port'];
        $instanceConfig['management_port'] = $v['managementPort'];

        $rangeIp = new IP($defaultRanges[$i]);

        $v6_gateway = $ipConfig->v('v6', 'prefix').$rangeIp->getFirstHostAs6();
        $v6_net = $v6_gateway.'/96';

        $ipC = [
            'v4_network' => $rangeIp->getNetwork(),
            'v4_netmask' => $rangeIp->getNetmask(),
            'v6_network' => $v6_net,
            'v6_gateway' => $v6_gateway,
        ];

#        $ipC['v4_network'] = $rangeIp->getNetwork();
#        $ipC['v4_netmask'] = $rangeIp->getNetmask();

        $vpnConfig = implode(
            PHP_EOL,
            $serverConfig->get(
                array_merge(
                    $instanceConfig,
                    $dhParam,
                    $ipC,
                    $configData['certificate']
                )
            )
        );

        file_put_contents(sprintf('/etc/openvpn/server-%s.conf', $k), $vpnConfig);
    }
} catch (Exception $e) {
    echo $e->getMessage().PHP_EOL;
    exit(1);
}
